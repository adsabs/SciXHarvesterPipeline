============================= test session starts ==============================
platform darwin -- Python 3.9.6, pytest-7.2.0, pluggy-1.0.0
rootdir: /Users/sao/ADS_repos/harvester_pipeline, configfile: pytest.ini
plugins: requests-mock-1.10.0, celery-4.4.2, cov-4.0.0
collected 5 items

tests/harvester/test_metadata_arxiv_harvester.py ....F                   [100%]

=================================== FAILURES ===================================
_______________ test_ArXiV_Harvester.test_arxiv_harvesting_main ________________

self = <test_metadata_arxiv_harvester.test_ArXiV_Harvester testMethod=test_arxiv_harvesting_main>

    def test_arxiv_harvesting_main(self):
        mock_job_request = {"task_args":{"daterange":"2023-03-07", "resumptionToken": None}, "task": "ARXIV"}
        with base.base_utils.mock_multiple_targets({'get_schema': patch.object(utils, 'get_schema', return_value = "")}) as mocked:
            mock_app = Harvester_APP(proj_home='tests/data')
            producer = AvroProducer({'schema.registry.url': 'http://127.0.0.1:9001'})
>           arxiv_harvesting(mock_app, mock_job_request, producer)

tests/harvester/test_metadata_arxiv_harvester.py:67: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
harvester/metadata/arxiv_harvester.py:27: in arxiv_harvesting
    harvester_output_schema = get_schema(app, app.schema_client, app.config.get('HARVESTER_OUTPUT_SCHEMA'))
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

app = <harvester.harvester.Harvester_APP object at 0x10a8b9160>
schema_client = None, schema_name = 'HarvesterOutputSchema'

    def get_schema(app, schema_client, schema_name):
        try:
            avro_schema = schema_client.get_latest_version(schema_name)
            app.logger.info("Found schema: {}".format(avro_schema.schema.schema_str))
        except Exception as e:
            avro_schema = None
            app.logger.warning("Could not retrieve avro schema with exception: {}".format(e))
    
>       return avro_schema.schema.schema_str
E       AttributeError: 'NoneType' object has no attribute 'schema'

harvester/utils.py:16: AttributeError
----------------------------- Captured stderr call -----------------------------
%5|1678296424.556|CONFWARN|rdkafka#producer-1| [thrd:app]: No `bootstrap.servers` configured: client will not be able to connect to Kafka cluster
------------------------------ Captured log call -------------------------------
WARNING  harvester.harvester:utils.py:14 Could not retrieve avro schema with exception: 'NoneType' object has no attribute 'get_latest_version'
=============================== warnings summary ===============================
harvester/utils.py:4
  /Users/sao/ADS_repos/harvester_pipeline/harvester/utils.py:4: DeprecationWarning: the imp module is deprecated in favour of importlib; see the module's documentation for alternative uses
    import imp

tests/harvester/test_metadata_arxiv_harvester.py::test_ArXiV_Harvester::test_arxiv_harvesting_main
  /Users/sao/ADS_repos/harvester_pipeline/venv/lib/python3.9/site-packages/sqlalchemy/util/langhelpers.py:253: SADeprecationWarning: The 'postgres' dialect name has been renamed to 'postgresql'
    loader = self.auto_fn(name)

tests/harvester/test_metadata_arxiv_harvester.py::test_ArXiV_Harvester::test_arxiv_harvesting_main
  /Users/sao/ADS_repos/harvester_pipeline/venv/lib/python3.9/site-packages/redis/client.py:961: DeprecationWarning: "charset" is deprecated. Use "encoding" instead
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html

---------- coverage: platform darwin, python 3.9.6-final-0 -----------
Name                                                          Stmts   Miss  Cover   Missing
-------------------------------------------------------------------------------------------
harvester/base/OAIHarvester.py                                   17      6    65%   9-11, 21-23
harvester/db.py                                                  82     69    16%   9-10, 13-25, 32-44, 50-58, 64-72, 78-87, 93-104, 110-114
harvester/harvester.py                                           62     31    50%   22-30, 33-34, 54-78
harvester/metadata/arxiv_harvester.py                            85     16    81%   29-51
harvester/models.py                                              31      0   100%
harvester/s3_methods.py                                          27      9    67%   7-13, 21-27
harvester/utils.py                                               77     28    64%   11, 35-37, 54-68, 94, 96, 110-119
harvester_gRPC/gRPCHarvester/avro_serializer.py                  29     29     0%   1-35
harvester_gRPC/gRPCHarvester/grpc_modules/harvester_grpc.py      34     34     0%   2-123
harvester_gRPC/gRPCHarvester/harvester_client.py                 60     60     0%   14-110
harvester_gRPC/gRPCHarvester/harvester_server.py                191    191     0%   14-249
-------------------------------------------------------------------------------------------
TOTAL                                                           695    473    32%

=========================== short test summary info ============================
FAILED tests/harvester/test_metadata_arxiv_harvester.py::test_ArXiV_Harvester::test_arxiv_harvesting_main
=================== 1 failed, 4 passed, 3 warnings in 7.53s ====================
